<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="The Fire Hacker">
<meta name="dcterms.date" content="2025-01-16">

<title>Learning CUDA Kernels: From Zero to Running Custom GPU Code – The Fire Hacker</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-665a47377fd1fb2966ef7e6e7341ee54.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V1B8R98P79"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V1B8R98P79', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">The Fire Hacker</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../til.html"> 
<span class="menu-text">Today I Learned</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/thefirehacker"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/thefirehacker"> <i class="bi bi-twitter" role="img" aria-label="X (Twitter)">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-journey-running-my-first-cuda-kernel" id="toc-the-journey-running-my-first-cuda-kernel" class="nav-link active" data-scroll-target="#the-journey-running-my-first-cuda-kernel">The Journey: Running My First CUDA Kernel</a></li>
  <li><a href="#the-setup-wsl2-cuda-pytorch" id="toc-the-setup-wsl2-cuda-pytorch" class="nav-link" data-scroll-target="#the-setup-wsl2-cuda-pytorch">The Setup: WSL2 + CUDA + PyTorch</a>
  <ul class="collapse">
  <li><a href="#environment-configuration" id="toc-environment-configuration" class="nav-link" data-scroll-target="#environment-configuration">1. Environment Configuration</a></li>
  <li><a href="#pytorch-with-cuda-support" id="toc-pytorch-with-cuda-support" class="nav-link" data-scroll-target="#pytorch-with-cuda-support">2. PyTorch with CUDA Support</a></li>
  </ul></li>
  <li><a href="#the-project-gpu-modes-reference-kernels" id="toc-the-project-gpu-modes-reference-kernels" class="nav-link" data-scroll-target="#the-project-gpu-modes-reference-kernels">The Project: GPU-Mode’s Reference Kernels</a></li>
  <li><a href="#understanding-the-cuda-kernel-code" id="toc-understanding-the-cuda-kernel-code" class="nav-link" data-scroll-target="#understanding-the-cuda-kernel-code">Understanding the CUDA Kernel Code</a>
  <ul class="collapse">
  <li><a href="#the-cuda-kernel-function" id="toc-the-cuda-kernel-function" class="nav-link" data-scroll-target="#the-cuda-kernel-function">The CUDA Kernel Function</a></li>
  <li><a href="#the-host-code-cpu-side" id="toc-the-host-code-cpu-side" class="nav-link" data-scroll-target="#the-host-code-cpu-side">The Host Code (CPU Side)</a></li>
  <li><a href="#pytorch-integration" id="toc-pytorch-integration" class="nav-link" data-scroll-target="#pytorch-integration">PyTorch Integration</a></li>
  </ul></li>
  <li><a href="#understanding-the-benchmarking-script" id="toc-understanding-the-benchmarking-script" class="nav-link" data-scroll-target="#understanding-the-benchmarking-script">Understanding the Benchmarking Script</a>
  <ul class="collapse">
  <li><a href="#key-components" id="toc-key-components" class="nav-link" data-scroll-target="#key-components">Key Components:</a></li>
  </ul></li>
  <li><a href="#my-results-on-rtx-2050" id="toc-my-results-on-rtx-2050" class="nav-link" data-scroll-target="#my-results-on-rtx-2050">My Results on RTX 2050</a>
  <ul class="collapse">
  <li><a href="#performance-analysis" id="toc-performance-analysis" class="nav-link" data-scroll-target="#performance-analysis">Performance Analysis:</a></li>
  </ul></li>
  <li><a href="#key-lessons-learned" id="toc-key-lessons-learned" class="nav-link" data-scroll-target="#key-lessons-learned">Key Lessons Learned</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  <li><a href="#resources-for-beginners" id="toc-resources-for-beginners" class="nav-link" data-scroll-target="#resources-for-beginners">Resources for Beginners</a></li>
  <li><a href="#the-aha-moment" id="toc-the-aha-moment" class="nav-link" data-scroll-target="#the-aha-moment">The “Aha!” Moment</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Learning CUDA Kernels: From Zero to Running Custom GPU Code</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>The Fire Hacker </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 16, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="the-journey-running-my-first-cuda-kernel" class="level2">
<h2 class="anchored" data-anchor-id="the-journey-running-my-first-cuda-kernel">The Journey: Running My First CUDA Kernel</h2>
<p>Today I successfully compiled and ran my first custom CUDA kernel on my RTX 2050 gaming laptop! Here’s everything I learned about GPU programming, from environment setup to understanding performance metrics.</p>
</section>
<section id="the-setup-wsl2-cuda-pytorch" class="level2">
<h2 class="anchored" data-anchor-id="the-setup-wsl2-cuda-pytorch">The Setup: WSL2 + CUDA + PyTorch</h2>
<p>Getting CUDA to work on Windows through WSL2 was my first challenge. Here’s the complete path I took:</p>
<section id="environment-configuration" class="level3">
<h3 class="anchored" data-anchor-id="environment-configuration">1. Environment Configuration</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install CUDA Toolkit 12.1 (for nvcc compiler)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> dpkg <span class="at">-i</span> cuda-keyring_1.1-1_all.deb</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install <span class="at">-y</span> cuda-toolkit-12-1</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up environment variables</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">CUDA_HOME</span><span class="op">=</span>/usr/local/cuda-12.1</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span><span class="va">$CUDA_HOME</span>/bin:<span class="va">$PATH</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">LD_LIBRARY_PATH</span><span class="op">=</span><span class="va">$CUDA_HOME</span>/lib64:<span class="va">$LD_LIBRARY_PATH</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="pytorch-with-cuda-support" class="level3">
<h3 class="anchored" data-anchor-id="pytorch-with-cuda-support">2. PyTorch with CUDA Support</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install PyTorch with CUDA 12.1 support</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">--index-url</span> https://download.pytorch.org/whl/cu121 torch</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="the-project-gpu-modes-reference-kernels" class="level2">
<h2 class="anchored" data-anchor-id="the-project-gpu-modes-reference-kernels">The Project: GPU-Mode’s Reference Kernels</h2>
<p>I worked with the <a href="https://github.com/thefirehacker/reference-kernels">reference-kernels</a> repository, specifically the <code>vectoradd_py</code> problem. This repository contains practice problems for learning GPU kernel optimization.</p>
</section>
<section id="understanding-the-cuda-kernel-code" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-cuda-kernel-code">Understanding the CUDA Kernel Code</h2>
<p>Let me break down the <code>submission.py</code> file that implements vector addition on the GPU:</p>
<section id="the-cuda-kernel-function" class="level3">
<h3 class="anchored" data-anchor-id="the-cuda-kernel-function">The CUDA Kernel Function</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">typename</span> <span class="dt">scalar_t</span><span class="op">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>__global__ <span class="dt">void</span> add_kernel<span class="op">(</span><span class="at">const</span> <span class="dt">scalar_t</span><span class="op">*</span> <span class="ex">__restrict__</span> A<span class="op">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">const</span> <span class="dt">scalar_t</span><span class="op">*</span> <span class="ex">__restrict__</span> B<span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                           <span class="dt">scalar_t</span><span class="op">*</span> <span class="ex">__restrict__</span> C<span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                           <span class="dt">int</span> N<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> idx <span class="op">=</span> blockIdx<span class="op">.</span>x <span class="op">*</span> blockDim<span class="op">.</span>x <span class="op">+</span> threadIdx<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>idx <span class="op">&lt;</span> N<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        C<span class="op">[</span>idx<span class="op">]</span> <span class="op">=</span> A<span class="op">[</span>idx<span class="op">]</span> <span class="op">+</span> B<span class="op">[</span>idx<span class="op">];</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Key Concepts I Learned:</strong></p>
<ol type="1">
<li><p><strong><code>__global__</code></strong>: This marks a function that runs on the GPU and is called from the CPU (host)</p></li>
<li><p><strong>Thread Indexing</strong>:</p>
<ul>
<li><code>blockIdx.x</code>: Which block this thread belongs to</li>
<li><code>blockDim.x</code>: Number of threads per block</li>
<li><code>threadIdx.x</code>: Thread’s position within its block</li>
<li><code>idx = blockIdx.x * blockDim.x + threadIdx.x</code>: Global thread index calculation</li>
</ul></li>
<li><p><strong><code>__restrict__</code></strong>: Tells compiler these pointers don’t overlap, enabling optimizations</p></li>
<li><p><strong>Boundary Check</strong>: <code>if (idx &lt; N)</code> prevents out-of-bounds memory access since we might launch more threads than elements</p></li>
</ol>
</section>
<section id="the-host-code-cpu-side" class="level3">
<h3 class="anchored" data-anchor-id="the-host-code-cpu-side">The Host Code (CPU Side)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>torch<span class="op">::</span>Tensor add_cuda<span class="op">(</span>torch<span class="op">::</span>Tensor A<span class="op">,</span> torch<span class="op">::</span>Tensor B<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> N <span class="op">=</span> A<span class="op">.</span>numel<span class="op">();</span>  <span class="co">// Total number of elements</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> C <span class="op">=</span> torch<span class="op">::</span>empty_like<span class="op">(</span>A<span class="op">);</span>  <span class="co">// Allocate output tensor</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> threads <span class="op">=</span> <span class="dv">256</span><span class="op">;</span>  <span class="co">// Threads per block</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> blocks <span class="op">=</span> <span class="op">(</span>N <span class="op">+</span> threads <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> threads<span class="op">;</span>  <span class="co">// Number of blocks needed</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    AT_DISPATCH_FLOATING_TYPES_AND_HALF<span class="op">(</span>A<span class="op">.</span><span class="dt">scalar_type</span><span class="op">(),</span> <span class="st">"add_kernel"</span><span class="op">,</span> <span class="op">([&amp;]</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        add_kernel<span class="op">&lt;</span><span class="dt">scalar_t</span><span class="op">&gt;&lt;&lt;&lt;</span>blocks<span class="op">,</span> threads<span class="op">&gt;&gt;&gt;(</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            A<span class="op">.</span>data_ptr<span class="op">&lt;</span><span class="dt">scalar_t</span><span class="op">&gt;(),</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>            B<span class="op">.</span>data_ptr<span class="op">&lt;</span><span class="dt">scalar_t</span><span class="op">&gt;(),</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            C<span class="op">.</span>data_ptr<span class="op">&lt;</span><span class="dt">scalar_t</span><span class="op">&gt;(),</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            N</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}));</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>What I Learned Here:</strong></p>
<ol type="1">
<li><p><strong>Block and Thread Configuration</strong>:</p>
<ul>
<li>256 threads per block is a common choice (multiple of 32, the warp size)</li>
<li>Calculate blocks needed: <code>(N + threads - 1) / threads</code> (ceiling division)</li>
</ul></li>
<li><p><strong>Kernel Launch Syntax</strong>: <code>&lt;&lt;&lt;blocks, threads&gt;&gt;&gt;</code> is CUDA’s special syntax for launching kernels</p></li>
<li><p><strong>Type Dispatching</strong>: <code>AT_DISPATCH_FLOATING_TYPES_AND_HALF</code> handles different data types (float32, float64, float16)</p></li>
</ol>
</section>
<section id="pytorch-integration" class="level3">
<h3 class="anchored" data-anchor-id="pytorch-integration">PyTorch Integration</h3>
<p>The really cool part is using PyTorch’s <code>load_inline</code> to compile CUDA code on-the-fly:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>add_module <span class="op">=</span> load_inline(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">'add_cuda'</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    cpp_sources<span class="op">=</span>add_cpp_source,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    cuda_sources<span class="op">=</span>add_cuda_source,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    functions<span class="op">=</span>[<span class="st">'add_cuda'</span>],</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This compiles the CUDA code using <code>nvcc</code> behind the scenes and creates a Python module!</p>
</section>
</section>
<section id="understanding-the-benchmarking-script" class="level2">
<h2 class="anchored" data-anchor-id="understanding-the-benchmarking-script">Understanding the Benchmarking Script</h2>
<p>The <code>run_local.py</code> script taught me about proper GPU performance measurement:</p>
<section id="key-components" class="level3">
<h3 class="anchored" data-anchor-id="key-components">Key Components:</h3>
<ol type="1">
<li><strong>Automatic Size Detection</strong>:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick sizes that fit in VRAM (80% of available)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>free_bytes, _ <span class="op">=</span> torch.cuda.mem_get_info()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>budget <span class="op">=</span> <span class="bu">int</span>(free_bytes <span class="op">*</span> <span class="fl">0.8</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> dims <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For 2D tensors (matrices)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    s_max <span class="op">=</span> <span class="bu">int</span>(math.sqrt(budget <span class="op">/</span> (<span class="dv">3</span> <span class="op">*</span> bytes_per_elem)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This prevents out-of-memory errors by choosing appropriate test sizes based on available VRAM.</p>
<ol start="2" type="1">
<li><strong>CUDA Event Timing</strong>:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> torch.cuda.Event(enable_timing<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> torch.cuda.Event(enable_timing<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>t0.record()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>custom_kernel(case)  <span class="co"># Run the kernel</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>t1.record()</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>torch.cuda.synchronize()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>elapsed <span class="op">=</span> t0.elapsed_time(t1)  <span class="co"># Time in milliseconds</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Why CUDA Events?</strong> Regular Python timing wouldn’t work because CUDA operations are asynchronous. CUDA events measure time on the GPU itself.</p>
<ol start="3" type="1">
<li><strong>Warmup Runs</strong>: The script does 10 warmup iterations before timing. This is crucial because:
<ul>
<li>First kernel launch includes JIT compilation overhead</li>
<li>GPU needs to “warm up” to reach peak performance clocks</li>
</ul></li>
</ol>
</section>
</section>
<section id="my-results-on-rtx-2050" class="level2">
<h2 class="anchored" data-anchor-id="my-results-on-rtx-2050">My Results on RTX 2050</h2>
<pre><code>Detected dims=2, free≈3.47 GB, using sizes=[4096, 8192, 12288, 16384]
size=4096:  mean=0.9877 ms, best=0.9461 ms, worst=1.2061 ms
size=8192:  mean=3.8027 ms, best=3.7571 ms, worst=3.9188 ms
size=12288: mean=8.5460 ms, best=8.4602 ms, worst=8.8747 ms
size=16384: mean=150.3063 ms, best=144.3062 ms, worst=169.5191 ms</code></pre>
<section id="performance-analysis" class="level3">
<h3 class="anchored" data-anchor-id="performance-analysis">Performance Analysis:</h3>
<ol type="1">
<li><p><strong>Linear Scaling (mostly)</strong>: 4096→8192 (4x elements) took ~4x time, which is expected</p></li>
<li><p><strong>The 16384 Anomaly</strong>: Suddenly 17x slower! This taught me about:</p>
<ul>
<li><strong>Block Scheduling Overhead</strong>: With 256 threads/block, 16384×16384 elements need 1,048,576 blocks!</li>
<li><strong>Solution</strong>: Use grid-stride loops where each thread processes multiple elements</li>
</ul></li>
<li><p><strong>Memory Bandwidth</strong>: For simple operations like addition, we’re memory-bound:</p>
<ul>
<li>8192×8192 elements × 2 bytes × 3 tensors = 402 MB</li>
<li>3.76 ms → ~107 GB/s effective bandwidth</li>
</ul></li>
</ol>
</section>
</section>
<section id="key-lessons-learned" class="level2">
<h2 class="anchored" data-anchor-id="key-lessons-learned">Key Lessons Learned</h2>
<ol type="1">
<li><p><strong>GPU Programming is Different</strong>: You think in terms of thousands of parallel threads, not sequential loops</p></li>
<li><p><strong>Memory is King</strong>: Most simple kernels are limited by memory bandwidth, not compute</p></li>
<li><p><strong>Launch Configuration Matters</strong>: Too many blocks can cause scheduling overhead</p></li>
<li><p><strong>Measure Correctly</strong>: Always use CUDA events for timing, not CPU timers</p></li>
<li><p><strong>Check Boundaries</strong>: GPU won’t stop you from accessing invalid memory - it’ll just crash!</p></li>
<li><p><strong>Start Simple</strong>: Vector addition is perfect for learning because it’s simple enough to understand but shows all core concepts</p></li>
</ol>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next Steps</h2>
<p>Now that I understand the basics, I want to explore: - Shared memory optimization - Warp-level primitives - More complex kernels (matrix multiplication, reductions) - Performance profiling with Nsight</p>
</section>
<section id="resources-for-beginners" class="level2">
<h2 class="anchored" data-anchor-id="resources-for-beginners">Resources for Beginners</h2>
<ul>
<li><strong>Repository</strong>: <a href="https://github.com/thefirehacker/reference-kernels">reference-kernels</a> - Great practice problems</li>
<li><strong>PMPP Book</strong>: “Programming Massively Parallel Processors” - The theory behind these kernels</li>
<li><strong>CUDA Documentation</strong>: <a href="https://docs.nvidia.com/cuda">docs.nvidia.com/cuda</a> - Official reference</li>
<li><strong>GPU Mode Discord</strong>: Community of learners working through these problems together</li>
</ul>
</section>
<section id="the-aha-moment" class="level2">
<h2 class="anchored" data-anchor-id="the-aha-moment">The “Aha!” Moment</h2>
<p>The biggest realization: <strong>A GPU is not just a fast CPU</strong>. It’s a completely different architecture that requires rethinking how we approach problems. Instead of “do this step by step,” we think “do this everywhere at once.”</p>
<p>When that mental shift clicked, suddenly the weird syntax and concepts started making sense. Every thread knows its identity (index) and does its small part of the work. Together, thousands of threads solve the problem in parallel.</p>
<hr>
<p><em>This learning journey continues! Follow along as I tackle more complex kernels and optimization techniques.</em></p>


</section>

</main> <!-- /main -->
<!-- Enhanced Google Analytics 4 Implementation for The Fire Hacker -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V1B8R98P79"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  
  // Initialize GA4 with enhanced configuration
  gtag('js', new Date());
  gtag('config', 'G-V1B8R98P79', {
    // Enhanced ecommerce and engagement tracking
    send_page_view: true,
    page_title: document.title,
    page_location: window.location.href,
    
    // Enhanced measurement features
    enhanced_measurement: {
      scrolls: true,
      outbound_clicks: true,
      site_search: true,
      video_engagement: true,
      file_downloads: true
    },
    
    // Custom parameters for The Fire Hacker
    custom_map: {
      'dimension1': 'page_type',
      'dimension2': 'content_category',
      'dimension3': 'user_engagement_level'
    },
    
    // Debug mode (remove in production if needed)
    debug_mode: false
  });

  // Set custom dimensions based on page
  const pageType = window.location.pathname.includes('/blog/') ? 'blog_post' :
                   window.location.pathname.includes('/til/') ? 'til_post' :
                   window.location.pathname === '/' || window.location.pathname === '/index.html' ? 'homepage' :
                   window.location.pathname.includes('/about') ? 'about' :
                   'other';

  const contentCategory = window.location.pathname.includes('/blog/') ? 'blog' :
                         window.location.pathname.includes('/til/') ? 'today_i_learned' :
                         'main_site';

  // Send custom dimensions
  gtag('config', 'G-V1B8R98P79', {
    'custom_map.dimension1': pageType,
    'custom_map.dimension2': contentCategory
  });

  // Enhanced page view with custom parameters
  gtag('event', 'page_view', {
    'page_type': pageType,
    'content_category': contentCategory,
    'site_name': 'The Fire Hacker',
    'author': 'Fire Hacker',
    'contact_email': 'firehacker@bubblspace.com'
  });

  // Track mailto clicks to firehacker@bubblspace.com
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('a[href^="mailto:firehacker@bubblspace.com"]').forEach(function(link) {
      link.addEventListener('click', function() {
        gtag('event', 'email_contact', {
          'contact_email': 'firehacker@bubblspace.com',
          'contact_method': 'mailto_link'
        });
      });
    });
  });
</script>

<!-- Load enhanced tracking script -->
<script src="analytics.js"></script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>